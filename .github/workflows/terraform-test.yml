name: Terraform Test
on:
    push:
        branches: ['main']
env:
    TF_VAR_subscription_id: ${{secrets.SUBSCRIPTION_ID}}
    TF_VAR_sql_admin_login_username: ${{secrets.SQL_ADMIN_LOGIN_USERNAME}}
    TF_VAR_sql_admin_login_password: ${{secrets.SQL_ADMIN_LOGIN_PASSWORD}}

    ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID}}
    ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
    ARM_TENANT_ID: ${{secrets.ARM_TENANT_ID}}
    ARM_SUBSCRIPTION_ID: ${{secrets.ARM_SUBSCRIPTION_ID}}
jobs:
    terraform-test:
        runs-on: ubuntu-latest

        steps:
            - name: 'Checkout repository'
              uses: actions/checkout@v4

            - name: 'Set up Terraform'
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.7.6

            - name: 'Terraform Init'
              run: terraform init

            - name: 'Terraform Format Check'
              run: terraform fmt -check -recursive

            - name: 'Terraform Validate'
              run: terraform validate

            - name: 'Terraform Plan'
              run: terraform plan -out=tfplan
    terraform-deploy:
        runs-on: ubuntu-latest
        needs: terraform-test

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.7.6
            - name: Initialize Terraform
              run: terraform init
            - name: 'Terraform Apply'
              run: terraform apply -auto-approve tfplan
